<!DOCTYPE HTML>
<html>
    <head>
        <title>%DEVICEID%</title>
        <meta content="width=device-width, initial-scale=0.8, user-scalable=yes" name="viewport">
        <meta http-equiv="Cache-Control" content="max-age=31536000, immutable" />
        <link rel="stylesheet" type="text/css" href="style.css">
        <meta charset="UTF-8">
        <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
        <link rel="icon" sizes="192x192" href="android-chrome-192x192.png">
        <link rel="icon" href="favicon.ico">
        <link rel="manifest" href="manifest.json">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="theme-color" content="#ffffff">
    </head>
    <body>
      <h3 id="HEADLINE">%DEVICEID%</h3>
    
      <div class="outerring" id="RING_ID">
       <div class="innerring"></div>
        <div class="temp_room">
          <img src="temp_inside.png"><div id="TEMP_ROOM">--.-</div>
        </div>
        <div class="temp_room">
          <img src="temp_outside.png"><div id="TEMP_OUT">--.-</div>
        </div>
        <div class="temp_room"></div>
       <div>
        <div id="ICON_STATUS" class="icon_status" onclick="window.location.href='http://192.168.2.23/#/Dashboard'" ><img id="ICON_IMG" src="poweroff.png"></div>
        <div id="KW_IN" class="ringtext_value"  onclick="window.location.href='http://192.168.2.23/#/Devices/77/Log'">xx.xxx</div>
        <div id="COP_AKT" class="ringtext_value2" onclick="window.location.href='http://192.168.2.23/#/Devices/78/Log'" >xx.x</div>
       </div>
       <div>
        <div class="value_status" id="WP_STATUS">--</div>
        <div class="ringtext_unit">[kW-In]</div>
        <div class="ringtext_unit2">[COP-Akt.]</div>
       </div>
       <div class="ringtext_status2" id="SGR_STATUS">--</div>
     </div>
     <table>
            <tr>
              <td id="WW_IST" onclick="window.location.href='http://192.168.2.23/#/Devices/4562/Log'">--</td>
              <td id="VL_IST" onclick="window.location.href='http://192.168.2.23/#/Devices/4557/Log'">--</td>
              <td id="RL_IST" onclick="window.location.href='http://192.168.2.23/#/Devices/4558/Log'">--</td>
            </tr>
            <tr>
              <th>WW[&#8451;]</th>
              <th>VL[&#8451;]</th>
              <th>RL[&#8451;]</th>
            </tr>
            <tr>
              <td id="RL_VL_IST">--</td>
              <td id="RLSOLL_RLIST">--</td>
              <td id="RL_SOLL" onclick="window.location.href='http://192.168.2.23/#/Devices/4559/Log'">--</td>
            </tr>
            <tr>
              <th>VL-RL &Delta;</th>
              <th>RL-SOLL &Delta;</th>
              <th>RL-SOLL</th>
            </tr>
        </table>
        <table>
              <tr>
              <td id="WW_COP">--</td>
              <td id="HE_COP">--</td>
              <td id="SUM_COP">--</td>
            </tr>
            <tr>
              <th>COP WW   </th>
              <th>COP HEIZ </th>
              <th>COP SUM  </th>
            </tr>
            <tr>
              <td id="WW_COPDAY">--</td>
              <td id="HE_COPDAY">--</td>
              <td id="SUM_COPDAY">--</td>
            </tr>
            <tr>
              <th>Day-COP WW   </th>
              <th>Day-COP HEIZ </th>
              <th>Day-COP SUM  </th>
            </tr>
      </table>
    <button type="button" class="image-btn" onclick="window.location.href='log.html'"><img src="file-list.png">Log</button>
    <button type="button" class="image-btn" onclick="window.location.href='luxtronik.html'"><img src="heatpump.png">Anlage</button>
    <button type="button" class="image-btn" onclick="window.location.href='http://192.168.2.23#/Dashboard'"><img src="homeauto.png">Domoticz</button>
    <button type="button" class="image-btn" onclick="luxrequest()"><img src="luxtronik.png">Luxtronik</button>
    <button type="button" class="image-btn" onclick="window.location.href='smartgrid.html'"><img src="sg.png">SmartGrid</button>
    <button type="button" class="image-btn" onclick="window.location.href='shi.html'"><img src="shi.png">Smart-Home</button>
    <button type="button" class="image-btn" onclick="window.location.href='meter.html'"><img src="current.png">Meter</button>
    <button type="button" class="image-btn" onclick="window.location.href='setup.html'"><img src="settings.png">Setup</button>
         
    <script type="text/javascript">

          
            function luxrequest()
            {
             // Test:
             //luxurl = "http://192.168.2.101";
             luxurl = "http://" + "%LUX_IP%";
             window.location.href = luxurl;
            }
            function reqListener ()
            {
              // Test
              //var myResponse = "08:02,1,0.50,Heizen,19.3,7.0,29.4,30.0,34.1,0.67,2.57,2206.0,310.7,2516.7,8125.3,1101.6,9226.9,3.97,0.00,3.97,534,30.0,Aus,Aus,1798,7.8,3.69,10.82,23.9,0.0,0.0,649,6.3,24.03.25 11:42,01:09:43,29.1,1800,20.6,-125,01:01:01,keine Anford.,end"
              var myResponse = this.responseText;
              var myArray = myResponse.split(",");
            
              //console.log(myArray);
              sgrStatus = String(myArray[1]);
              wpStatus = "--";
              
              // PV-Anteil al ring-Anteil darstellen
              var r = document.querySelector(':root');
              r.style.setProperty('--ringcolor', 'red');

              if (myArray[1] != null)
              {
               // pv Anteil 
               let pwrmeter_in = myArray[5];
               let pwrwp_in    = myArray[3];
               let pvdeckung = 0;
               if (pwrmeter_in > pwrwp_in)
               {
                 pvdeckung = 2;
               }
               else
               if (pwrmeter_in <= 0)
               {
                pvdeckung = 358;
               }
               else
               {
                pvdeckung = pwrwp_in - pwrmeter_in;
                pvdeckung = (1- (pwrmeter_in / pwrwp_in))*360 ;
                pvdeckung = Math.floor(pvdeckung);
               }

               let _txt = pvdeckung.toString() + 'deg';
               r.style.setProperty('--pwrplus', _txt);

               document.getElementById('HEADLINE').innerHTML = '%DEVICEID%' + '&emsp;' + myArray[0];
               document.getElementById('SGR_STATUS').innerHTML  = "SGready-Mode:" + sgrStatus;
               document.getElementById('TEMP_ROOM').textContent = myArray[10];    
               document.getElementById('TEMP_OUT').textContent  = myArray[11];
               // -------------------------
               // Test
               //wpStatus = 'HEI'
              var wpStatus = String(myArray[2]); // status Heatpump
              var wpIcon = 'poweroff.png';
             
              if (wpStatus.indexOf('HEI') >=0)
              {
                wpIcon = 'radiator.png';
                document.getElementById('RING_ID').className = "outerring_blink"; 
                //document.getElementById('RING_ID').style.background = 'red';
                r.style.setProperty('--ringcolor', 'red');
              }
              else if (wpStatus.indexOf('AB') >=0)
              {
                wpIcon = 'defrost.png';
                document.getElementById('RING_ID').className = "outerring_blink";
                //document.getElementById('RING_ID').style.background = 'blue';
                r.style.setProperty('--ringcolor', 'blue');
              }
              else if (wpStatus.indexOf('W') >= 0)
              { 
                wpIcon = 'hotwater.png';
                document.getElementById('RING_ID').className = "outerring_blink";
                //document.getElementById('RING_ID').style.background = 'orange';
                r.style.setProperty('--ringcolor', 'orange');
              }
              else
              {
                document.getElementById('RING_ID').style.background = 'gray';
                wpStatus = 'OFF';
              }
              document.getElementById('WP_STATUS').innerHTML = wpStatus;
              document.getElementById('ICON_IMG').src = wpIcon;
              // -----------------------
               document.getElementById('KW_IN').innerHTML   = myArray[3] / 1000;

               document.getElementById('WW_IST').innerHTML  = myArray[12];
            
               document.getElementById('RL_IST').innerHTML  = myArray[13];
               document.getElementById('RL_SOLL').innerHTML = myArray[14];
               document.getElementById('VL_IST').innerHTML  = myArray[15];
                                           
               // COP-Day
               //document.getElementById('WW_COPDAY').innerHTML  = (myArray[] * 1.0);
               //document.getElementById('HE_COPDAY').innerHTML  = myArray[17];
               // for Test COP Sum
               document.getElementById('SUM_COP').innerHTML = ((myArray[9] * 1.0) / (myArray[8] * 1.0)).toFixed(2);

               let rldelta = (myArray[13]) - (myArray[14]);
               document.getElementById('RLSOLL_RLIST').innerHTML = rldelta.toFixed(1);

               let vlrldelta = (myArray[13]) - (myArray[15]);
               document.getElementById('RL_VL_IST').innerHTML = vlrldelta.toFixed(1);

               if (parseFloat( myArray[7]) > 0)
               {
                 document.getElementById('COP_AKT').innerHTML = ((myArray[7] *1.0) / myArray[6]).toFixed(2);
               }
               else
               {
                document.getElementById('COP_AKT').innerHTML = "--"
               }

              }
            }
            var oReq = new XMLHttpRequest();
            oReq.addEventListener("load", reqListener);
            setInterval(function()
            {
              //var dateNow = new Date();  // current time
              oReq.open("GET", "/fetch");
              oReq.send();
            }, 2000);
    </script>
    </body>
</html>
